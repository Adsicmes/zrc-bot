# 牛牛大作战 · 设计草稿

## 目标与背景

- 本 Bot 的**通用货币**以「牛牛长度」表示，在群聊中通过「导」「日」等行为随机变化，形成轻量娱乐向的数值博弈与排行。
- 数值单位：**长度（cm）**，约分到**小数点后两位**；可为正数或负数。

---

## 名词定义（本插件内）

| 名词 | 含义 |
|------|------|
| **牛牛 / 牛子** | 通用货币，以长度(cm)计，保留两位小数，可正可负。 |
| **导** | 改变**自身**牛牛长度的行为（一次操作 = 一次「设了」）。 |
| **日 / 草 / 操** | 改变**他人**牛牛长度的行为（一次操作 = 一次「设了」）。 |
| **射精 / 射了 / 设了** | 计量单位：每发生一次「导」或「日」计为 1 次「设了」。例如「设了 5 次」表示当天导+日共 5 次。 |
| **群友** | 群聊中的成员（本插件内指可被查询/被「日」的对象）。 |

---

## 初始与变化规则

- **初始长度**：每人首次参与时牛牛长度为 **8.00 cm**。
- **单次变化幅度**：导 / 日 单次对长度的增减，一般控制在 **±2.00 cm** 以内（具体分布可配置，见下）。

---

## 指令约定

- **不带斜杠**：所有指令均不带 `/` 前缀。
- **支持多种说法**：同一行为可配置多种触发词（例如 日/草/操，射了/设了 等），实现时按同义匹配。

## 命令与行为

### 导（改变自己）

- **触发**：发送「导」或配置的同义说法。
- **效果**：自己的牛牛长度按「设了曲线」随机增减（幅度约 ±2cm 内）。
- **计数**：**对发起者**当日「设了」次数 +1，参与概率曲线。

### 日群友（改变他人）

- **触发**：
  - **单独发送**（如「日群友」「日」等）：系统**随机选择**当前群内一名**除自己以外**的群友，对其牛牛长度进行一次变化。
  - **@某人**：对**指定群友**的牛牛长度进行一次变化。
- **效果**：目标用户的牛牛长度按「设了曲线」随机增减（幅度约 ±2cm 内）。
- **计数**：**对发起者**当日「设了」次数 +1。

### 查询与排行（可选）

- 查询自己的牛牛：指令 **我的牛牛**。
- 查询某群友的牛牛：如「查 @某人」或单独指令+@（具体文案待定）。
- 群内排行：如「本群牛牛榜」按长度排序（可选功能）。

---

## 算法：设了曲线（导与日共用）

- **导**与**日**使用**同一条概率曲线**，统一按「发起者」当日**设了次数**计算，即：全部使用「设了」曲线。
- **每日第一次设了**：**必定增加**牛牛长度。
- **第二次及以后**：增加概率随 n 递减，减少概率随 n 递增（指数型）。

### 具体公式与随机浮动

- 设 `n = 发起者当日已设了次数`（本次操作前的值）。
- `n = 0` → 本次结果强制为「增加」。
- `n ≥ 1` → 使用**具体公式**计算基础概率，再叠加**随机上下浮动**：
  - **基础公式**：`p_base(n) = base * decay^n`（指数衰减），其中 `base`、`decay` 为可配置参数（如 base=0.8, decay=0.7），保证随 n 增大 p 单调递减。
  - **随机浮动**：在 `p_base(n)` 上加减一个小范围随机值（如 ±0.05），再 clamp 到 [0, 1]，得到本次「增加」的概率 `p_increase`；「减少」概率 = `1 - p_increase`。
- **幅度**：增减的绝对值在 ±2cm 内，可由均匀分布或加权随机生成；具体分布可配置。

---

## 数据模型

- **维度**：**按「群 + 用户」**存储，即同一用户在不同群拥有独立数据。
- **用户牛牛长度**：表字段至少包含 群 ID、用户 ID、当前长度、最后更新时间。首次出现时写入 8.00。
- **当日设了次数**：按**发起者**计数，存储「群 + 用户 + 日期」维度，用于设了曲线计算。
- 存储使用现有 `db`（SQLite + SQLAlchemy），新增表，不修改现有业务表。

---

## 权限与配置

- **使用范围**：**仅群聊**，私聊不开放本插件功能。
- **权限**：默认群友可「导」、「日群友」、查自己的牛牛及排行；**管理员**可**修改某人的各类数据**（如牛牛长度、当日设了次数等），用于纠错或运营。
- **配置项（可选）**：  
  - 单次变化上下限（默认 ±2cm）。  
  - 设了曲线参数（base、decay、随机浮动范围）。  
  - 各指令的多种说法（同义触发词列表）。

---

## 与现有插件的关系

- 独立新插件，不依赖 HelloPlugin；可依赖项目内 `db` 做持久化。
- 命令注册走 NcatBot 的 `command_registry` / `filter_registry`，权限可挂现有权限组或仅群内可见。

---

## 待定问题（TBD）

1. 查询他人牛牛、排行的具体指令文案（如「查 @某人」「牛牛榜」等）。
2. 管理员修改数据的入口形式（专用指令 + 参数，或配置/后台，待定）。
3. 幅度分布（±2cm 内均匀还是加权）及默认 base/decay/浮动范围的具体数值。

---

*本文档为设计草稿，仅用于规划与讨论；实现前需再评审并定稿。*

最后更新：2025-02-13 14:30
