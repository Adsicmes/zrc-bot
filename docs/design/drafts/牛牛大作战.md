# 牛牛大作战 · 设计草稿

- **插件代码 ID（英文）**：**NiuNiuBattle**（目录名、插件类名、配置命名等统一使用此 ID）。

## 目标与背景

- 本 Bot 的**通用货币**以「牛牛长度」表示，在群聊中通过「导」「日」等行为随机变化，形成轻量娱乐向的数值博弈与排行。
- 数值单位：**长度（cm）**，约分到**小数点后两位**；可为正数或负数。

---

## 名词定义（本插件内）

| 名词 | 含义 |
|------|------|
| **牛牛 / 牛子** | 通用货币，以长度(cm)计，保留两位小数，可正可负。 |
| **导** | 改变**自身**牛牛长度的行为（一次操作 = 一次「设了」）。 |
| **日 / 草 / 操** | 改变**他人**牛牛长度的行为（一次操作 = 一次「设了」）。 |
| **射精 / 射了 / 设了** | 计量单位：每发生一次「导」或「日」计为 1 次「设了」。例如「设了 5 次」表示当天导+日共 5 次。 |
| **群友** | 群聊中的成员（本插件内指可被查询/被「日」的对象）。 |

---

## 初始与变化规则

- **初始长度**：每人首次参与时牛牛长度为 **8.00 cm**。
- **单次变化幅度**：导 / 日 单次对长度的增减，一般控制在 **±2.00 cm** 以内（具体分布可配置，见下）。

---

## 指令约定

- **不带斜杠**：所有指令均不带 `/` 前缀。
- **支持多种说法**：同一行为可配置多种触发词（例如 日群友/草群友/操群友，射了/设了 等），实现时按同义匹配。

## 命令与行为

### 导（改变自己）

- **触发**：发送「导」或配置的同义说法。
- **效果**：自己的牛牛长度按「设了曲线」随机增减（幅度约 ±2cm 内）。
- **计数**：**对发起者**当日「设了」次数 +1，参与概率曲线。

### 日群友（改变他人）

- **触发**：
  - **单独发送**（如「日群友」「草群友」「操群友」等）：系统**随机选择**当前群内一名**除自己以外**的群友，对其牛牛长度进行一次变化。
  - **@某人**：对**指定群友**的牛牛长度进行一次变化。若 @ 的是自己，**禁止**并提示用户使用「导」指令。
- **效果**：目标用户的牛牛长度按「设了曲线」随机增减（幅度约 ±2cm 内）。
- **计数**：**对发起者**当日「设了」次数 +1。

### 查询与排行

- **查询自己的牛牛**：指令 **我的牛牛**。
- **查询他人牛牛**：指令 **查看牛牛@某人**（需 @ 指定群友）。
- **牛牛排行榜**：指令 **牛牛排行榜**（仅此一种说法）。展示本群内**长度前十位**（最长 10 人）与**长度后十位**（最短 10 人）；人数不足 20 时按实际人数展示，前后两段可重叠或不足十位。

### 管理员：按群禁用/解除禁用用户（RBAC）

- **禁用牛牛@某人**：仅管理员，当前群。将「被 @ 用户」在当前群使用牛牛大作战的权限设为 RBAC 黑名单（路径 `niuniu.use.<group_id>`），该用户在本群将无法使用任何牛牛指令直至被解除。
- **解除禁用牛牛@某人**：仅管理员，当前群。移除被 @ 用户在该路径上的黑名单，恢复其在本群使用牛牛大作战。

---

## 算法：设了曲线（导与日共用）

- **导**与**日**使用**同一条概率曲线**，统一按「发起者」当日**设了次数**计算，即：全部使用「设了」曲线。
- **每日第一次设了**：**必定增加**牛牛长度。
- **第二次及以后**：增加概率随 n 递减，减少概率随 n 递增（指数型）。

### 具体公式与随机浮动

- 设 `n = 发起者当日已设了次数`（本次操作前的值）。
- `n = 0` → 本次结果强制为「增加」。
- `n ≥ 1` → 使用**具体公式**计算基础概率，再叠加**随机上下浮动**：
  - **基础公式**：`p_base(n) = base * decay^n`（指数衰减），其中 `base`、`decay` 为可配置参数（如 base=0.8, decay=0.7），保证随 n 增大 p 单调递减。
  - **随机浮动**：在 `p_base(n)` 上加减一个小范围随机值，再 clamp 到 [0, 1]，得到本次「增加」的概率；「减少」概率 = 1 - p_increase。
- **幅度**：增减的绝对值在 ±2cm 内，具体分布见下「默认参数建议」。

### 默认参数建议

- **幅度分布**：建议 **±2cm 内均匀分布**。即先随机「增加」或「减少」，再在 [0, 2] 上均匀取变化量（单位 cm），实现简单且结果公平；若希望小幅变化更多，可改为加权（如偏向 0.5～1cm），首版推荐均匀即可。
- **设了曲线**：`p_base(n) = base * decay^n`。建议 **base = 0.85，decay = 0.6**，使 n=1 时约 51% 增加、n=2 约 31%、n=3 约 18%，衰减较快；可配置覆盖。
- **随机浮动**：建议 **±0.06**，在 p_base 上加减后 clamp 到 [0,1]，避免概率过于确定。

---

## 数据模型

- **维度**：**按「群 + 用户」**存储，即同一用户在不同群拥有独立数据。
- **用户牛牛长度**：表字段至少包含 群 ID、用户 ID、当前长度、最后更新时间。首次出现时写入 8.00。
- **当日设了次数**：按**发起者**计数，存储「群 + 用户 + 日期」维度，用于设了曲线计算。
- 存储使用现有 `db`（SQLite + SQLAlchemy），新增表，不修改现有业务表。

### 表结构建议（技术）

| 表名（示例） | 字段 | 类型 | 说明 |
|--------------|------|------|------|
| `niuniu_user` | group_id | str | 群 ID |
| | user_id | str | 用户 ID |
| | length | Decimal(10,2) 或 float 存时 round 到 2 位 | 当前牛牛长度 (cm) |
| | updated_at | datetime | 最后更新时间 |
| | (唯一) | (group_id, user_id) | 唯一约束 |
| `niuniu_daily_count` | group_id | str | 群 ID |
| | user_id | str | 用户 ID（发起者） |
| | date | date 或 str "YYYY-MM-DD" | 自然日，用于「当日」 |
| | count | int | 当日设了次数 |
| | (唯一) | (group_id, user_id, date) | 唯一约束 |

- **日期**：建议按**本地自然日**（运行环境 date）计算「当日」，避免时区歧义；若多地域部署再考虑 UTC。
- **长度**：写入 DB 前 `round(x, 2)`，保证两位小数。

### 管理员「键」与表字段对应

| 指令中的键（示例） | 对应存储 | 数值类型 |
|--------------------|----------|----------|
| 长度 | niuniu_user.length | 小数，保留两位 |
| 设了次数 | niuniu_daily_count.count（当日记录） | 非负整数；设置时用「当前日期」对应的记录，若无则插入 |

实现时键名与表字段的映射可配置（如 长度→length），便于扩展。

### 可用群聊的存储与设置方式（技术）

- **存储**：**使用 NcatBot 插件配置项**持久化可用群聊列表。配置项 `enabled_group_ids` 存于 `data/NiuNiuBattle/NiuNiuBattle.yaml`，管理员通过「开启/关闭牛牛大作战」修改后写回；也可用系统命令 `/set_config NiuNiuBattle enabled_group_ids [...]` 或 `/cfg` 修改。参见 [插件配置项](https://docs.ncatbot.xyz/guide/plugin-config/)。
- **默认行为**：**可用群聊列表为空时，默认全部不开放**；由管理员在目标群内发送「开启牛牛大作战」逐群加入列表。
- **设置方式**：**仅在当前群聊**内发送管理员指令——**开启牛牛大作战**（将当前群 ID 加入可用列表并写回配置）、**关闭牛牛大作战**（将当前群 ID 从列表中移除并写回配置）。不在其他群或私聊中传群 ID，仅「当前群」生效。
- **校验**：所有导/日/查询/排行榜/设置牛牛 的 handler 入口先判断 `当前群 ID in 可用群聊列表`，不在则直接 return 或提示「本群未开放牛牛大作战」。

### 按群禁用用户（RBAC 黑名单 · 方案二）

- **目的**：支持管理员在某一群内**禁用指定用户**使用牛牛大作战全部指令（导、日群友、我的牛牛、查看牛牛、排行榜等）；被禁用后该用户在该群发任何牛牛指令均被拒绝并提示。
- **实现方式**：使用 NcatBot 的 **RBAC 权限路径 + 黑名单**，不新增插件内表或配置。
- **权限路径约定**：
  - 路径格式：`niuniu.use.<group_id>`（例如 `niuniu.use.123456789`）。
  - 语义：表示「在该群使用牛牛大作战」的权限。若对某**用户**将该路径加入**黑名单**，则该用户在该群不能使用任何牛牛指令。
- **路径注册**：当管理员在群内执行**开启牛牛大作战**时，除将当前群 ID 加入配置的 `enabled_group_ids` 外，需调用 RBAC `add_permissions("niuniu.use." + group_id)`（若路径已存在则忽略），确保该群对应路径存在。
- **禁用操作**（仅管理员，当前群）：
  - 指令：**禁用牛牛@某人**。解析 @ 得到目标用户 ID。
  - 内部：`status.global_access_manager.assign_permissions_to_user(target_user_id, "niuniu.use." + group_id, mode="black")`，将「在该群使用牛牛」设为该用户的黑名单。
  - 若目标已是管理员/root，建议允许操作但提示「已禁用，该用户在本群无法使用牛牛大作战」；可选：禁止对 admin/root 禁用，实现时择一并在文档写明。
- **解除禁用**（仅管理员，当前群）：
  - 指令：**解除禁用牛牛@某人**。解析 @ 得到目标用户 ID。
  - 内部：`status.global_access_manager.revoke_permissions_from_user(target_user_id, "niuniu.use." + group_id)`，移除该用户对该路径的黑名单（若未在黑名单则无副作用）。
- **校验顺序**：在已通过「当前群在可用群聊列表」的前提下，在处理具体指令（导、日、查询等）之前，先执行：  
  `status.global_access_manager.check_permission(user_id, "niuniu.use." + group_id)`  
  - 若返回 **False**（用户被黑名单或路径不存在时 RBAC 会拒绝），则视为**该用户在本群已被禁用**，回复提示「你在本群已被禁用牛牛大作战」并 return，不执行任何牛牛逻辑。
  - 若返回 True，继续原有指令逻辑。
- **与关闭群的区别**：「关闭牛牛大作战」是整群不可用（从 enabled_group_ids 移除）；「禁用牛牛@某人」仅针对单个用户在该群不可用，其他群友照常使用。关闭群后无需删除 RBAC 中该群的路径，再次开启时路径通常仍在；若实现时在关闭时删除路径，则再次开启时需重新 `add_permissions`。
- **数据归属**：禁用/解除禁用数据保存在 NcatBot 的 `data/rbac.json` 中，与插件配置分离；其他插件理论上可复用同一套 RBAC 路径约定（若需跨插件「某人在某群禁用」可沿用 `niuniu.use.<group_id>` 或扩展路径命名）。

---

## 权限与配置

- **使用范围**：**仅群聊**，私聊不开放本插件功能。
- **可用群聊**：**支持设置哪些群可使用本插件**。仅当当前群在「可用群聊」列表内时，才响应导、日群友、查询、排行榜、设置牛牛等所有指令；**未在列表内的群不响应**（静默忽略或提示「本群未开放牛牛大作战」）。列表**使用配置文件**存储；**在当前群聊**发送**开启牛牛大作战** / **关闭牛牛大作战**（仅管理员）可把当前群加入或移出列表，写回配置。**列表为空时默认全部不开放**。
- **权限**：在可用群内，默认群友可「导」、「日群友」、查自己/他人牛牛及排行榜；**管理员**可在该群内发送**设置牛牛@某人 键 数值**修改某人数据，**开启/关闭牛牛大作战**管理当前群是否可用，以及**禁用牛牛@某人** / **解除禁用牛牛@某人** 管理当前群内某用户是否可使用牛牛（见上「按群禁用用户」）。**键**为该用户在本群内**所有与牛牛相关的数据字段**，与数据模型中的可写字段一致（如 长度、当日设了次数 等），实现时按表结构暴露即可。例如：`设置牛牛@张三 长度 10.50`、`设置牛牛@李四 设了次数 0`。
- **配置项（可选）**：  
  - **可用群聊**：群 ID 列表，存于配置文件；**为空时默认全部不开放**。  
  - 单次变化上下限（默认 ±2cm）。  
  - 设了曲线参数（base、decay、随机浮动范围）。  
  - 导/日/我的牛牛等指令的多种说法（同义触发词）；排行榜仅一种说法「牛牛排行榜」。

---

## 技术细化：指令解析与边界

### 指令匹配方式

- **纯文本/前缀匹配**：我的牛牛、牛牛排行榜、导、日群友（及同义说法）— 消息文本等于或以约定词开头即可触发，注意避免与其它插件冲突。
- **带 @ 的指令**：  
  - **查看牛牛@某人**：解析消息中的 at 段（OneBot at 段或 @QQ号），取第一个被 @ 的用户作为对象；若无 @ 则提示「请 @ 要查看的用户」。  
  - **设置牛牛@某人 键 数值**：同上解析 @ 目标；其后为两段：键（如 长度、设了次数）、数值（支持小数与整数）。解析失败时提示格式错误。

### 随机选人（日群友 单独发送）

- 从**当前群成员列表**中排除发起者本人，得到候选列表；若候选为空（仅自己或 Bot 无法取到成员列表），则**不执行变化**并提示「群内没有可日的对象」或「暂时无法随机到人」。
- 随机选一人后，对该目标的牛牛长度应用设了曲线（**发起者的**当日设了次数参与概率计算，目标仅被改长度）。

### 边界与异常

| 场景 | 处理建议 |
|------|----------|
| 日群友 单独发送，群内除自己外 0 人 | 提示「群内没有可日的对象」，不扣设了次数、不改变任何长度。 |
| 日群友 @ 了自己 | **禁止**并提示「不能日自己，想改自己的长度请用【导】指令」。不执行变化、不扣设了次数。 |
| 查看牛牛@某人，该人在本群无记录 | 视为**首次参与**，显示 8.00 cm（或提示「该用户尚未参与，当前为初始长度 8.00 cm」）。 |
| 牛牛排行榜，本群 0 人参与 | 提示「本群暂无牛牛数据」。 |
| 排行榜人数 1～19 | 前十与后十按实际人数展示，可重叠（如共 5 人则前五=后五）。 |
| 设置牛牛 键/数值 非法或越权 | 按「键与数值校验规则」提示（见下）；非管理员发送则忽略或提示无权限。 |
| 导/日 时发起者或目标无记录 | 先**自动初始化**该用户在本群的数据（长度 8.00，当日设了 0），再执行变化。 |
| 当前群不在可用群聊列表 | 不响应任何牛牛指令，静默忽略或回复「本群未开放牛牛大作战」。 |
| 当前用户在本群已被禁用（RBAC 黑名单） | 回复「你在本群已被禁用牛牛大作战」，不执行任何牛牛指令。 |

### 实现要点（公式与数值）

- **概率判定**：`p = clamp(p_base(n) + random.uniform(-0.06, 0.06), 0, 1)`，再 `random.random() < p` 判为增加，否则减少。
- **幅度**：方向确定后，`delta = random.uniform(0, 2)`（cm），再根据方向取正负，`new_length = round(old_length + delta, 2)`。
- **设了次数**：先读取「群+发起者+今日」的 count，用 n 参与概率计算；本次操作提交前将该 count +1（或插入 1）。

### 键与数值校验规则（设置牛牛）

- **键**：仅支持与数据模型可写字段对应的键（如 **长度**、**设了次数**）。未识别的键 → 提示「未知键【xxx】，支持的键：长度、设了次数」。
- **长度**：数值须为可解析为小数，且建议限制在**合理范围**（如 -999.99～999.99 cm），避免异常数据；超出范围 → 提示「长度需在 -999.99 到 999.99 之间」；格式错误 → 提示「长度必须是数字」。
- **设了次数**：数值须为可解析为非负整数；负数 → 提示「设了次数不能为负数」；非整数 → 提示「设了次数必须是整数」。
- **通用**：参数缺失（如未 @ 某人、缺少键或数值）→ 提示「格式错误，正确示例：设置牛牛@某人 长度 10.50」。

---

## 与现有插件的关系

- 独立新插件，**插件 ID 英文 NiuNiuBattle**，不依赖 HelloPlugin；可依赖项目内 `db` 做持久化。
- 命令注册走 NcatBot 的 `command_registry` / `filter_registry`，权限可挂现有权限组或仅群内可见。

---

## 实现顺序建议

1. 可用群聊的配置文件读写与校验（enabled_group_ids + 入口判断）。  
2. 建表（niuniu_user、niuniu_daily_count）及初始化/查询封装。  
3. 导、日群友（含随机选人、@ 指定、@ 自己禁止并提示用导）及设了曲线、幅度计算。  
4. 我的牛牛、查看牛牛@某人、牛牛排行榜。  
5. 管理员指令 设置牛牛@某人 键 数值 及键与数值校验、权限校验。  
6. 管理员指令 开启牛牛大作战 / 关闭牛牛大作战（当前群，写回配置）；开启时注册 RBAC 路径 `niuniu.use.<group_id>`。  
7. 按群禁用用户：管理员指令 禁用牛牛@某人 / 解除禁用牛牛@某人（RBAC 黑名单），及指令入口处 `check_permission` 校验。  
8. 多说法（同义触发词）与配置项。

## 待定问题（TBD）

1. 禁用牛牛@某人 时，若目标为 admin/root：允许禁用并生效，或禁止并提示「不能禁用管理员」— 实现时择一并在文档写明。

---

*本文档为设计草稿，仅用于规划与讨论；实现前需再评审并定稿。*

最后更新：2025-02-13 18:15
