# 牛牛大作战 · 指令触发优化（避免误触发）

- **关联插件**：NiuNiuBattle（牛牛大作战）
- **草稿日期**：2026-02-14
- **目标**：在使用「导」「日群友」等指令时，避免因**讨论机制**的句子（如「导的越多 减的几率越大」）被当成指令执行。

---

## 背景与问题

当前实现中，部分指令使用「**等于或前缀匹配**」触发：

| 指令类型 | 当前匹配方式 | 易误触发的示例 |
|----------|--------------|----------------|
| 导 | `text == "导"` 或 `text.startswith("导")` | 「导的越多 减的几率越大」「导多了会变短」 |
| 日群友 / 草群友 / 操群友 | 同上，前缀匹配 | 「日群友的时候」「草群友会不会减」 |
| 我的牛牛 / 我的牛子 | 同上 | 「我的牛牛怎么变短了」（讨论） |
| 牛牛排行榜 | 同上 | 「牛牛排行榜在哪看」 |

用户讨论规则、吐槽结果时，若句中**包含**触发词或以其开头，会被误识别为一次操作，导致：

- 无意中执行了「导」「日群友」等，改变长度或次数；
- 或误触发查询/排行榜，造成刷屏或困惑。

因此需要**收紧触发条件**，使「仅当用户明显在发指令时才触发」，而「讨论、解释、吐槽」不触发。

---

## 设计原则

1. **指令优先**：以「用户想执行一次操作/查询」为触发依据，而非「消息里出现关键词」。
2. **讨论不触发**：整句是自然语言（如说明、问句、吐槽）时，即使含有「导」「日群友」等词，也不触发。
3. **兼容现有用法**：已约定俗成的**纯指令写法**（如单独发「导」「日群友」「我的牛牛」）必须继续触发。**空格**视为合法变体（如 `导 `、` 日群友 `）；**标点**不视为变体，带标点不触发。

---

## 触发规则草案

### 1. 导

- **视为指令**：消息 strip 后仅为下列之一时触发：
  - 等于 `导`（无前后缀，或前后仅有**空白**）；
  - 即「单独一个导」或「导」前后仅带空格，视为指令。**带标点（如 `导。`）不触发**。
- **不触发**：`导` 后紧跟其它汉字/英文/数字等**连续内容**（如「导的」「导多了」「导 3 次」），或带标点（如「导。」），均不触发。

即：**仅「导」或「导」+ 前后空格**触发，其余不触发。

### 2. 日群友 / 草群友 / 操群友

- **视为指令**：满足其一（**仅允许空白变体，不允许标点**）：
  - 整句 strip 后**等于**某条触发词（如 `日群友`、`草群友`、`操群友`），或触发词前后仅带空白；
  - 或整句以某条触发词**开头**，且**紧接着**仅为：空白 + @某人，**且 @ 之后不再有任何其它文字**（即仅「触发词」或「触发词 + 空白 + @某人」）。
- **不触发**：触发词后跟自然语句（如「日群友的时候」「草群友会不会减」）、带标点、或 **「日群友 @张三 谢谢」** 等带任意后缀的，均不触发。

### 3. 我的牛牛 / 我的牛子

- **视为指令**：整句 strip 后**等于**「我的牛牛」或「我的牛子」，或该词前后仅带空白。带标点不触发。
- **不触发**：后面还有其它字词（如「我的牛牛怎么变短了」「我的牛子没了」）或标点，不触发。

### 4. 牛牛排行榜

- **视为指令**：整句 strip 后**等于**「牛牛排行榜」，或前后仅带空白。带标点不触发。
- **不触发**：如「牛牛排行榜在哪」「牛牛排行榜怎么看」等，不触发。

### 5. 查看牛牛、设置牛牛、开启/关闭牛牛大作战

- **查看牛牛**：仍以「查看牛牛」开头，但要求后面**仅有**空白与 @某人，无大段说明文字；若只有「查看牛牛」而无 @，继续按现有逻辑提示「请 @ 要查看的用户」。
- **设置牛牛**：同现有逻辑，以「设置牛牛」开头 + @ + 键值，不在此次「避免讨论误触发」范围做收缩（可按需后续单独约定）。
- **开启牛牛大作战 / 关闭牛牛大作战**：保持**整句完全匹配**即可（当前已是整句匹配），无需改动。

---

## 实现要点（供后续编码参考）

1. **导**：由 `text == t or text.startswith(t)` 改为 **仅** `text.strip()` 等于 `导`。不允许标点变体，仅允许前后空格。
2. **日群友 / 草群友 / 操群友**：  
   - 要么 strip 后整句等于触发词（仅允许前后空白，不允许标点）；  
   - 要么匹配「触发词 + 空白 + @某人」且 **@ 之后不再有任何其它内容**（仅 @ 段与空白）。  
   「日群友 @张三 谢谢」等带后缀的**不触发**。
3. **我的牛牛 / 我的牛子 / 牛牛排行榜**：由前缀匹配改为 **整句相等**（strip 后比较），仅允许前后空白，不允许标点。
4. **查看牛牛**：保留「以查看牛牛开头」，但去掉「查看牛牛」及空白、@ 后若仍剩其它文字则视为讨论不触发（可选）。

---

## 已定结论

- **空格**：视为合法变体（指令前后仅带空白可触发）。
- **标点**：不视为变体，带标点（如「导。」「日群友。」）不触发。
- **「日群友 @张三 谢谢」等带后缀**：不触发，仅允许「触发词」或「触发词 + 空白 + @某人」。
- **宽松/严格模式**：不提供，统一按上述规则。

---

## 与现有文档的关系

- 本草案补充 [牛牛大作战.md](牛牛大作战.md) 中「命令与行为」的**触发细节**，不改变规则语义（导/日的效果、设了曲线等不变）。
- 若采纳，建议在插件文档或用户说明中注明：**请单独发送指令词**，讨论机制时避免句首直接带「导」「日群友」等，或由实现收紧后自然避免误触发。

---

**最后更新：2026-02-14**
